name: Release

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "release" to confirm publishing to NuGet'
        required: true
        type: string

permissions:
  contents: write
  actions: write
  id-token: write  # Required for NuGet trusted publishing

env:
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Get latest CI run artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find the latest successful CI workflow run on main
          RUN_ID=$(gh run list \
            --workflow=ci.yml \
            --branch=main \
            --status=success \
            --limit=1 \
            --json databaseId \
            --jq '.[0].databaseId')

          if [ -z "$RUN_ID" ]; then
            echo "::error::No successful CI run found on main branch"
            exit 1
          fi

          echo "Downloading artifacts from run $RUN_ID"

          # Download the RC package artifact
          gh run download $RUN_ID --name rc-package --dir ./artifacts

          # List downloaded files
          echo "Downloaded artifacts:"
          ls -la ./artifacts/

      - name: Extract version from package
        id: version
        run: |
          # Get the nupkg filename and extract version
          NUPKG_FILE=$(ls ./artifacts/*.nupkg | head -1)
          FILENAME=$(basename "$NUPKG_FILE")
          # Extract version from filename: dotnet-dev-certs-plus.X.Y.Z.nupkg
          VERSION=$(echo "$FILENAME" | sed -E 's/dotnet-dev-certs-plus\.([0-9]+\.[0-9]+\.[0-9]+)\.nupkg/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "nupkg_file=${NUPKG_FILE}" >> $GITHUB_OUTPUT
          echo "## Release Version: ${VERSION}" >> $GITHUB_STEP_SUMMARY

      - name: NuGet login (trusted publishing)
        uses: nuget/login@v1
        with:
          user: DamianEdwards

      - name: Push to NuGet.org
        run: |
          dotnet nuget push ${{ steps.version.outputs.nupkg_file }} \
            --source "https://api.nuget.org/v3/index.json"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes "## dotnet-dev-certs-plus v${VERSION}

          ### Installation

          \`\`\`bash
          dotnet tool install --global dotnet-dev-certs-plus
          \`\`\`

          Or update an existing installation:

          \`\`\`bash
          dotnet tool update --global dotnet-dev-certs-plus
          \`\`\`

          ### What's New

          See the [commit history](https://github.com/${{ github.repository }}/commits/main) for changes in this release.

          ### Package

          - [NuGet.org](https://www.nuget.org/packages/dotnet-dev-certs-plus/${VERSION})
          " \
            ${{ steps.version.outputs.nupkg_file }}

      - name: Trigger CI workflow for next dev version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Trigger CI workflow with patch bump to update dev version
          gh workflow run ci.yml \
            --ref main \
            -f version_bump=none

          echo "Triggered CI workflow to update dev release with next patch version"

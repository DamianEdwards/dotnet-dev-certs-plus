name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'

env:
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      checks: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Calculate version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          # Get dev release body or releases list for initialization
          DEV_RELEASE_BODY=$(gh release view dev --json body --jq '.body // empty' 2>/dev/null || echo "")

          if [ -n "$DEV_RELEASE_BODY" ]; then
            # Parse state from dev release body
            STATE_JSON=$(dotnet scripts/version.cs -- state --body "$DEV_RELEASE_BODY")
          else
            # Initialize from releases
            RELEASES_JSON=$(gh release list --json tagName,isDraft,isPrerelease --limit 50 2>/dev/null || echo "[]")
            STATE_JSON=$(dotnet scripts/version.cs -- state --releases-json "$RELEASES_JSON")
          fi

          echo "Current state: $STATE_JSON"

          # Check for pending release
          PENDING=$(echo "$STATE_JSON" | jq -r '.pending')
          if [ "$PENDING" != "none" ]; then
            echo "Pending release detected ($PENDING), skipping dev build"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Calculate versions
          VERSIONS_JSON=$(dotnet scripts/version.cs -- calculate --state "$STATE_JSON")
          echo "Calculated versions: $VERSIONS_JSON"

          DEV_VERSION=$(echo "$VERSIONS_JSON" | jq -r '.devVersion')
          RC_VERSION=$(echo "$VERSIONS_JSON" | jq -r '.rcVersion')
          NEXT_STATE=$(echo "$VERSIONS_JSON" | jq -r '.nextState')

          echo "Dev version: $DEV_VERSION"
          echo "RC version: $RC_VERSION"

          # Output version info (compact JSON to single line for GITHUB_OUTPUT)
          STATE_JSON_COMPACT=$(echo "$STATE_JSON" | jq -c '.')
          echo "version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT
          echo "next_state=${NEXT_STATE}" >> $GITHUB_OUTPUT
          echo "state_json=${STATE_JSON_COMPACT}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

          # Summary
          echo "## Version Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Dev Version:** ${DEV_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **RC Version:** ${RC_VERSION}" >> $GITHUB_STEP_SUMMARY

      - name: Build
        if: steps.version.outputs.skip != 'true'
        uses: ./.github/actions/build
        with:
          version: ${{ steps.version.outputs.version }}

      - name: Test
        if: steps.version.outputs.skip != 'true'
        run: dotnet test test/dotnet-dev-certs-plus.Tests --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" --logger "html;LogFileName=test-results.html" --results-directory ./test-results

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always() && steps.version.outputs.skip != 'true'
        with:
          name: test-results
          path: |
            ./test-results/*.trx
            ./test-results/*.html
          retention-days: 30

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always() && steps.version.outputs.skip != 'true'
        with:
          name: Test Results
          path: ./test-results/*.trx
          reporter: dotnet-trx

      - name: Pack dev package
        if: steps.version.outputs.skip != 'true'
        run: |
          dotnet pack src/dotnet-dev-certs-plus/dotnet-dev-certs-plus.csproj \
            --configuration Release \
            --no-build \
            --output ./artifacts \
            -p:PackageVersion=${{ steps.version.outputs.version }}

      - name: Build RC package
        if: steps.version.outputs.skip != 'true'
        uses: ./.github/actions/build
        with:
          version: ${{ steps.version.outputs.rc_version }}

      - name: Pack RC package
        if: steps.version.outputs.skip != 'true'
        run: |
          dotnet pack src/dotnet-dev-certs-plus/dotnet-dev-certs-plus.csproj \
            --configuration Release \
            --no-build \
            --output ./artifacts-rc \
            -p:PackageVersion=${{ steps.version.outputs.rc_version }}

      - name: Upload package artifact
        if: steps.version.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: package
          path: ./artifacts/*.nupkg
          retention-days: 90

      - name: Upload RC package artifact
        if: steps.version.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: package-rc
          path: ./artifacts-rc/*.nupkg
          retention-days: 90

      - name: Push to GitHub Packages
        if: steps.version.outputs.skip != 'true'
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Update dev draft release
        if: steps.version.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RC_VERSION="${{ steps.version.outputs.rc_version }}"
          NEXT_STATE="${{ steps.version.outputs.next_state }}"

          # Delete existing dev release if exists
          if gh release view dev --json isDraft &>/dev/null; then
            gh release delete dev --yes
          fi

          # Create new dev draft release with state in body
          gh release create dev \
            --draft \
            --prerelease \
            --title "Development Build" \
            --notes "## Development Build

          **Dev Version:** ${VERSION}
          **RC Version:** ${RC_VERSION}
          **Commit:** ${{ github.sha }}
          **Build:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          This is an automatically updated pre-release containing the latest development build.

          ### Installation

          \`\`\`bash
          dotnet tool install --global dotnet-dev-certs-plus --version ${VERSION} --add-source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
          \`\`\`

          <!-- VERSION_STATE: ${NEXT_STATE} -->
          <!-- RC_VERSION: ${RC_VERSION} -->
          <!-- CI_RUN_ID: ${{ github.run_id }} -->
          " \
            ./artifacts/*.nupkg

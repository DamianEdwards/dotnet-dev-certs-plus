name: Bump Version

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (auto uses appropriate bump based on phase transition)'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
      phase:
        description: 'Target release phase'
        required: true
        type: choice
        options:
          - pre
          - rc
          - rtm

env:
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  bump:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Calculate new version
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION_BUMP: ${{ github.event.inputs.version_bump }}
          PHASE: ${{ github.event.inputs.phase }}
        run: |
          set -e

          # Get current state
          DEV_RELEASE_BODY=$(gh release view dev --json body --jq '.body // empty' 2>/dev/null || echo "")

          if [ -n "$DEV_RELEASE_BODY" ]; then
            STATE_JSON=$(dotnet scripts/version.cs -- state --body "$DEV_RELEASE_BODY")
          else
            RELEASES_JSON=$(gh release list --json tagName,isDraft,isPrerelease --limit 50 2>/dev/null || echo "[]")
            STATE_JSON=$(dotnet scripts/version.cs -- state --releases-json "$RELEASES_JSON")
          fi

          echo "Current state: $STATE_JSON"

          # Get releases for validation
          RELEASES_JSON=$(gh release list --json tagName,isDraft,isPrerelease --limit 100 2>/dev/null || echo "[]")

          # Apply bump
          NEW_STATE_JSON=$(dotnet scripts/version.cs -- bump \
            --state "$STATE_JSON" \
            --version-bump "$VERSION_BUMP" \
            --phase "$PHASE" \
            --releases-json "$RELEASES_JSON")

          if [ $? -ne 0 ]; then
            echo "::error::Version bump failed. See above for details."
            exit 1
          fi

          echo "New state: $NEW_STATE_JSON"

          # Calculate versions for the new state
          VERSIONS_JSON=$(dotnet scripts/version.cs -- calculate --state "$NEW_STATE_JSON")
          echo "Calculated versions: $VERSIONS_JSON"

          DEV_VERSION=$(echo "$VERSIONS_JSON" | jq -r '.devVersion')
          RC_VERSION=$(echo "$VERSIONS_JSON" | jq -r '.rcVersion')
          NEXT_STATE=$(echo "$VERSIONS_JSON" | jq -r '.nextState')

          echo "Dev version: $DEV_VERSION"
          echo "RC version: $RC_VERSION"

          # Output version info
          echo "version=${DEV_VERSION}" >> $GITHUB_OUTPUT
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT
          echo "next_state=${NEXT_STATE}" >> $GITHUB_OUTPUT
          echo "new_state_json=${NEW_STATE_JSON}" >> $GITHUB_OUTPUT

          # Summary
          echo "## Version Bump" >> $GITHUB_STEP_SUMMARY
          echo "- **Bump Type:** ${VERSION_BUMP}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Phase:** ${PHASE}" >> $GITHUB_STEP_SUMMARY
          echo "- **New Dev Version:** ${DEV_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **New RC Version:** ${RC_VERSION}" >> $GITHUB_STEP_SUMMARY

      - name: Build
        uses: ./.github/actions/build
        with:
          version: ${{ steps.version.outputs.version }}

      - name: Test
        run: dotnet test test/dotnet-dev-certs-plus.Tests --configuration Release --no-build --verbosity normal

      - name: Pack dev package
        run: |
          dotnet pack src/dotnet-dev-certs-plus/dotnet-dev-certs-plus.csproj \
            --configuration Release \
            --no-build \
            --output ./artifacts \
            -p:PackageVersion=${{ steps.version.outputs.version }}

      - name: Build RC package
        uses: ./.github/actions/build
        with:
          version: ${{ steps.version.outputs.rc_version }}

      - name: Pack RC package
        run: |
          dotnet pack src/dotnet-dev-certs-plus/dotnet-dev-certs-plus.csproj \
            --configuration Release \
            --no-build \
            --output ./artifacts-rc \
            -p:PackageVersion=${{ steps.version.outputs.rc_version }}

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package
          path: ./artifacts/*.nupkg
          retention-days: 90

      - name: Upload RC package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-rc
          path: ./artifacts-rc/*.nupkg
          retention-days: 90

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push ./artifacts/*.nupkg \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: Update dev draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RC_VERSION="${{ steps.version.outputs.rc_version }}"
          NEXT_STATE="${{ steps.version.outputs.next_state }}"

          # Delete existing dev release if exists
          if gh release view dev --json isDraft &>/dev/null; then
            gh release delete dev --yes
          fi

          # Create new dev draft release with state in body
          gh release create dev \
            --draft \
            --prerelease \
            --title "Development Build" \
            --notes "## Development Build

          **Dev Version:** ${VERSION}
          **RC Version:** ${RC_VERSION}
          **Commit:** ${{ github.sha }}
          **Build:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Version bumped via workflow dispatch.

          ### Installation

          \`\`\`bash
          dotnet tool install --global dotnet-dev-certs-plus --version ${VERSION} --add-source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
          \`\`\`

          <!-- VERSION_STATE: ${NEXT_STATE} -->
          <!-- RC_VERSION: ${RC_VERSION} -->
          <!-- CI_RUN_ID: ${{ github.run_id }} -->
          " \
            ./artifacts/*.nupkg
